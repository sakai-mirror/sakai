<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
 
 
  <!-- Logger for Search  -->
  <bean id="search-logger"
    parent="org.sakaiproject.service.framework.log.Logger">
  </bean>


  <bean id="org.sakaiproject.search.SearchService"
    class="org.sakaiproject.search.component.service.impl.SearchServiceImpl" 
    init-method="init" >
    <property name="logger"><ref bean="search-logger"/></property>
    <property name="searchIndexBuilder"><ref bean="org.sakaiproject.search.SearchIndexBuilder"/></property>
    <property name="indexDirectory"><value>${sakai.home}/searchindex</value></property>
  </bean> 
    
  <bean id="org.sakaiproject.search.SearchIndexBuilder"
    class="org.sakaiproject.search.component.service.impl.SearchIndexBuilderImpl" 
    init-method="init" >
    <property name="logger"><ref bean="search-logger"/></property>
    <property name="searchBuilderItemDao"><ref bean="searchBuilderItemDao" /></property>
    <property name="searchIndexBuilderWorker" ><ref bean="org.sakaiproject.search.SearchIndexBuilderWorker" /></property>
  </bean>

  <bean id="org.sakaiproject.search.SearchIndexBuilderWorker"
    class="org.sakaiproject.search.component.service.impl.SearchIndexBuilderWorker" 
    init-method="init" destroy-method="destroy">
    <property name="logger"><ref bean="search-logger"/></property>
    <property name="sleepTime"><value>30000</value></property>
    <property name="searchService"><ref bean="org.sakaiproject.search.SearchService"/></property>
    <property name="searchIndexBuilder"><ref bean="org.sakaiproject.search.SearchIndexBuilder" /></property>
    <property name="sessionFactory" ><ref bean="org.sakaiproject.search.SearchSessionFactory" /></property>
  </bean>
  
  <bean id="org.sakaiproject.search.SearchSessionFactory"
    parent="org.sakaiproject.springframework.orm.hibernate.SessionFactoryBase">
    
    <property name="dataSource">
      <ref bean="javax.sql.DataSource"/>
    </property>
    <property name="mappingResources">
      <list>
        <value>org/sakaiproject/search/model/impl/search.hbm.xml</value>
      </list>
    </property>
  </bean>
  
  <bean id="org.sakaiproject.search.SearchTransactionManager"
    class="org.springframework.orm.hibernate.HibernateTransactionManager">
    <property name="sessionFactory"><ref
      bean="org.sakaiproject.search.SearchSessionFactory"/>
    </property>
  </bean>
  
  <!-- START NEW STUFF -->
  <!-- Register the Data Access Object as a Transactional Interceptor -->
  <bean id="searchBuilderItemDao"
    class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
    <property name="transactionManager"><ref
      bean="org.sakaiproject.search.SearchTransactionManager"/>
    </property>
    <property name="transactionAttributes">
      <props>
        <!--
          <prop key="exists">PROPAGATION_REQUIRED,readOnly</prop>
          <prop key="find*">PROPAGATION_REQUIRED,readOnly</prop>
        -->
        <prop key="update*">PROPAGATION_REQUIRED</prop>
        <prop key="delete*">PROPAGATION_REQUIRED</prop>
        <!--. not needed for this version of create .-->
        <!--<prop key="create*">PROPAGATION_REQUIRED</prop>-->
      </props>
    </property>
    <property name="target"><ref bean="searchBuilderItemDaoImpl"/></property>
  </bean>
   
  <bean id="searchBuilderItemDaoImpl"
    class="org.sakaiproject.search.component.dao.impl.SearchBuilderItemDaoImpl" singleton="true">
    <property name="sessionFactory"><ref
      bean="org.sakaiproject.search.SearchSessionFactory"/>
    </property>
    <property name="log"><ref bean="search-logger"/></property>
  </bean>

  <bean id="wikiAdapter" 
    class="org.sakaiproject.search.component.adapter.RWikiEntityContentProducer"
    singleton="true"
    init-method="init" >
    <property name="objectService" ><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RWikiObjectService"/></property>
    <property name="renderService" ><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RenderService"/></property>
    <property name="searchService" ><ref bean="org.sakaiproject.search.SearchService" /></property>
    <property name="searchIndexBuilder" ><ref bean="org.sakaiproject.search.SearchIndexBuilder" /></property>
  </bean>
  

  <bean id="emailMessageAdapter" 
    class="org.sakaiproject.search.component.adapter.MessageContentProducer"
    singleton="true"
    init-method="init" >
    <property name="toolName" ><value>Email</value></property>
    <property name="addEvents" >
      <list>
        <value>mail.new</value>
        <value>mail.revise.own</value>
        <value>mail.revise.any</value>
      </list>
    </property>
    <property name="removeEvents" >
      <list>
        <value>mail.delete.own</value>
        <value>mail.delete.any</value>
      </list>
    </property>
    <property name="messageService" ><ref bean="org.sakaiproject.service.legacy.email.MailArchiveService"/></property>
    <property name="searchService" ><ref bean="org.sakaiproject.search.SearchService" /></property>
    <property name="searchIndexBuilder" ><ref bean="org.sakaiproject.search.SearchIndexBuilder" /></property>
  </bean>
  
  <bean id="discussionMessageAdapter" 
    class="org.sakaiproject.search.component.adapter.MessageContentProducer"
    singleton="true"
    init-method="init" >
    <property name="toolName" ><value>Discussion</value></property>
    <property name="addEvents" >
      <list>
        <value>disc.new</value>
        <value>disc.revise.own</value>
        <value>disc.revise.any</value>
      </list>
    </property>
    <property name="removeEvents" >
      <list>
        <value>disc.delete.own</value>
        <value>disc.delete.any</value>
      </list>
    </property>
    <property name="messageService" ><ref bean="org.sakaiproject.service.legacy.discussion.DiscussionService"/></property>
    <property name="searchService" ><ref bean="org.sakaiproject.search.SearchService" /></property>
    <property name="searchIndexBuilder" ><ref bean="org.sakaiproject.search.SearchIndexBuilder" /></property>
  </bean>
  <bean id="chatMessageAdapter" 
    class="org.sakaiproject.search.component.adapter.MessageContentProducer"
    singleton="true"
    init-method="init" >
    <property name="toolName" ><value>Chat</value></property>
    <property name="addEvents" >
      <list>
        <value>chat.new</value>
        <value>chat.revise.own</value>
        <value>chat.revise.any</value>
      </list>
    </property>
    <property name="removeEvents" >
      <list>
        <value>chat.delete.own</value>
        <value>chat.delete.any</value>
      </list>
    </property>
    <property name="messageService" ><ref bean="org.sakaiproject.service.legacy.chat.ChatService"/></property>
    <property name="searchService" ><ref bean="org.sakaiproject.search.SearchService" /></property>
    <property name="searchIndexBuilder" ><ref bean="org.sakaiproject.search.SearchIndexBuilder" /></property>
  </bean>
  <bean id="announcementMessageAdapter" 
    class="org.sakaiproject.search.component.adapter.MessageContentProducer"
    singleton="true"
    init-method="init" >
    <property name="toolName" ><value>Announcement</value></property>
    <property name="addEvents" >
      <list>
        <value>annc.new</value>
        <value>annc.revise.own</value>
        <value>annc.revise.any</value>
      </list>
    </property>
    <property name="removeEvents" >
      <list>
        <value>annc.delete.own</value>
        <value>annc.delete.any</value>
      </list>
    </property>
    <property name="messageService" ><ref bean="org.sakaiproject.service.legacy.announcement.AnnouncementService"/></property>
    <property name="searchService" ><ref bean="org.sakaiproject.search.SearchService" /></property>
    <property name="searchIndexBuilder" ><ref bean="org.sakaiproject.search.SearchIndexBuilder" /></property>
  </bean>
  
</beans>
