<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
	<!-- Logger for RWiki  -->
	<bean id="rwiki-logger"
		parent="org.sakaiproject.service.framework.log.Logger">
		
	</bean>
	
	<!-- each transaction manager, and therefore session factory must have its own data source,
	so overload here to avoid getting the central one -->
	<bean id="sakai-rwiki.javax.sql.DataSource" parent="javax.sql.DataSource">
	</bean>
	
	<!-- extend the  sakai base session factory -->
	<!--
	class="org.springframework.orm.hibernate.LocalSessionFactoryBean"
	-->
	<bean id="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"
		parent="org.sakaiproject.springframework.orm.hibernate.SessionFactoryBase">
		
		<property name="dataSource">
			<ref local="sakai-rwiki.javax.sql.DataSource"/>
		</property>
		<property name="mappingResources">
			<list>
				<value>
					uk/ac/cam/caret/sakai/rwiki/component/model/impl/RWiki.hbm.xml</value>
			</list>
		</property>
	</bean>
	
	<!-- START NEW STUFF -->
	<!-- Register the Data Access Object as a Transactional Interceptor -->
	<bean id="rwikiCurrentObjectDao"
		class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
		<property name="transactionManager"><ref
				bean="uk.ac.cam.caret.sakai.rwiki.RWikiTransactionManager"/>
			</property>
		<property name="transactionAttributes">
			<props>
				<!--
  				<prop key="exists">PROPAGATION_REQUIRED,readOnly</prop>
				<prop key="find*">PROPAGATION_REQUIRED,readOnly</prop>
				-->
				<prop key="update*">PROPAGATION_REQUIRED</prop>
				<prop key="delete*">PROPAGATION_REQUIRED</prop>
				<!--. not needed for this version of create .-->
				<!--<prop key="create*">PROPAGATION_REQUIRED</prop>-->
			</props>
		</property>
		<property name="target"><ref bean="rwikiCurrentObjectDaoImpl"/></property>
	</bean>
	<!-- DAO for current Object, acessed via Transaction Proxy -->
	<bean id="rwikiCurrentObjectDaoImpl"
		class="uk.ac.cam.caret.sakai.rwiki.component.dao.impl.RWikiCurrentObjectDaoImpl"
		singleton="true">
		<property name="sessionFactory"><ref
				bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
			</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="contentDAO"><ref bean="rwikiCurrentObjectContentDaoImpl" /></property>
		<property name="historyDAO"><ref bean="rwikiHistoryObjectDaoImpl" /></property>		
	</bean>
	
	<!-- DAO for Current Object Content -->
	<bean id="rwikiCurrentObjectContentDaoImpl"
		class="uk.ac.cam.caret.sakai.rwiki.component.dao.impl.RWikiCurrentObjectContentDaoImpl"
		singleton="true">
		<property name="sessionFactory"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
		</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
	</bean>
	
	<!-- Transaction Proxy for the HistoryObject -->
	<bean id="rwikiHistoryObjectDao"
		class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
		<property name="transactionManager"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiTransactionManager"/>
		</property>
		<property name="transactionAttributes">
			<props>
				<!--
					<prop key="exists">PROPAGATION_REQUIRED,readOnly</prop>
					<prop key="find*">PROPAGATION_REQUIRED,readOnly</prop>
				-->
				<prop key="update*">PROPAGATION_REQUIRED</prop>
				<prop key="delete*">PROPAGATION_REQUIRED</prop>
				<!--. not needed for this version of create .-->
				<!--<prop key="create*">PROPAGATION_REQUIRED</prop>-->
			</props>
		</property>
		<property name="target"><ref bean="rwikiHistoryObjectDaoImpl"/></property>
	</bean>
	
	<!-- DAO for the History Object -->
	<bean id="rwikiHistoryObjectDaoImpl"
		class="uk.ac.cam.caret.sakai.rwiki.component.dao.impl.RWikiHistoryObjectDaoImpl"
		singleton="true">
		<property name="sessionFactory"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
		</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="contentDAO"><ref bean="rwikiHistoryObjectContentDaoImpl" /></property>
	</bean>
	
	<!-- Content DAO of the history object -->
	<bean id="rwikiHistoryObjectContentDaoImpl"
		class="uk.ac.cam.caret.sakai.rwiki.component.dao.impl.RWikiHistoryObjectContentDaoImpl"
		singleton="true">
		<property name="sessionFactory"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
		</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
	</bean>
	
	<!-- Render Factory for creating Wiki Renderer Contexts -->
	<bean id="renderContextFactory"
		class="uk.ac.cam.caret.sakai.rwiki.component.radeox.service.impl.RenderContextFactoryImpl">
		<property name="log"><ref bean="rwiki-logger"/></property>
		
		<property name="objectService"><ref bean="objectService"/></property>
		<property name="securityService"><ref bean="securityService"/></property>
	</bean>
	
	<!-- Wiki engine factory -->
	<bean id="renderEngineFactory"
		class="uk.ac.cam.caret.sakai.rwiki.component.radeox.service.impl.RenderEngineFactoryImpl">
		<property name="log"><ref bean="rwiki-logger"/></property>
		
		<property name="objectService"><ref bean="objectService"/></property>
		<property name="renderEngine"><ref bean="baseRenderEngine"/></property>
		<property name="externalImageLink"><value>&lt;img src="/library/image/sakai/url.gif" alt="external link: " title="external link"/&gt;</value></property>
	</bean>
	
	<!-- Service for creating commands in URL Processing -->
	<bean id="commandService"
		class="uk.ac.cam.caret.sakai.rwiki.tool.service.impl.CommandServiceImpl">
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="commandMap">
			<map>
				<entry key="save"><ref bean="saveCommand"/></entry>
				<entry key="revert"><ref bean="revertCommand"/></entry>
				<entry key="updatePermissions"><ref bean="updatePermissionsCommand"/></entry>
				<entry key="editRealm"><ref bean="editRealmCommand"/></entry>
				<entry key="commenteditsave"><ref bean="commentSaveCommand"/></entry>
				<entry key="commentnewsave"><ref bean="commentNewCommand"/></entry>
				<!--<entry key=""><ref bean="Command"/></entry>-->
			</map>
		</property>
	</bean>
	
	<!-- Page Population service -->
	<bean id="populateService"
		class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.PopulateServiceImpl" 
		>
		
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="RWikiCurrentObjectDao"><ref bean="rwikiCurrentObjectDao"/></property>
		<property name="siteService"><ref bean="org.sakaiproject.service.legacy.site.SiteService" /></property>
		<property name="portalService"><ref bean="org.sakaiproject.service.framework.portal.PortalService" /></property>
		<property name="renderService"><ref bean="renderService" /></property>
		<property name="seedPages">
			<!--
			You can add a list of seed pages here, that are loaded into each context where they
			are not found. For performance purposes this is only done once per runtime of the 
			web app.
			
			The easiest way of creating new pages for seed, it to use the Rwiki tool in sakai to 
			edit the page, and then cut and paste the markup here with the required properties, then 
			restart the webapp. The Name should be a local name, as it will be converted to a suitable
			global name when the page is injected into the site, and the realm or use should not be set
			as these will be overwritten when the page is injected.
			-->
			<list>
				<ref bean="rwiki.seedPage.HomePage"/>
				<ref bean="rwiki.seedPage.HelpPage"/>
				<ref bean="rwiki.seedPage.RecentChangesPage"/>
				<ref bean="rwiki.seedPage.EditRightPage"/>
				<ref bean="rwiki.seedPage.DefaultTemplate"/>
				<ref bean="rwiki.seedPage.AboutProjectPage"/>
				<ref bean="rwiki.seedPage.AboutCoursePage"/>
			</list>
		</property>
	</bean>
	
	<bean id="securityService"
		class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.RWikiSecurityServiceImpl"
		 init-method="init" >
		<property name="log"><ref bean="rwiki-logger"/></property>
		
		<property name="portalService"><ref
				bean="org.sakaiproject.service.framework.portal.PortalService" />
			</property>
		<property name="securityService"><ref
				bean="org.sakaiproject.service.legacy.security.SecurityService"/>
			</property>
		<property name="siteService"><ref
				bean="org.sakaiproject.service.legacy.site.SiteService"/>
			</property>
	</bean>
	
	<!-- A Wrapper for the Render Component used at tool level -->
	<bean id="toolRenderService"
		class="uk.ac.cam.caret.sakai.rwiki.tool.service.impl.ToolRenderServiceImpl">
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="renderService"><ref bean="renderService"/></property>
	</bean>

     <!-- The component level Render service -->
	<bean id="renderService"
		class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.RenderServiceImpl">
		<property name="log"><ref bean="rwiki-logger"/></property>
		
		<property name="renderContextFactory"><ref bean="renderContextFactory"/>
			</property>
		<property name="renderEngineFactory"><ref bean="renderEngineFactory"/>
			</property>
			<!-- comment the cache out to disable it -->
		<property name="renderCache"><ref bean="rwikiRenderCache"/></property>
	</bean>
	
	<!-- The RWiki Object service, component level -->
	<bean id="objectService"
		class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.RWikiObjectServiceImpl">
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="renderService"><ref bean="renderService"/></property>
		<property name="RWikiCurrentObjectDao"><ref bean="rwikiCurrentObjectDao"/></property>
		<property name="RWikiHistoryObjectDao"><ref bean="rwikiHistoryObjectDao"/></property>
		<property name="securityService"><ref bean="securityService"/></property>
	</bean>
	
	<!-- Tool request processor -->
	<bean id="uk.ac.cam.caret.sakai.rwiki.tool.RequestHelper"
		class="uk.ac.cam.caret.sakai.rwiki.tool.RequestHelper">
		<property name="log"><ref bean="rwiki-logger"/></property>
		
		<property name="commandService"><ref bean="commandService"/></property>
	</bean>
	
	<!-- Save command -->
	<bean id="saveCommand"
		class="uk.ac.cam.caret.sakai.rwiki.tool.command.SaveCommand">
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="noUpdatePath"><value>/WEB-INF/command-pages/permission.jsp</value>
			</property>
		<property name="contentChangedPath"><value>/WEB-INF/command-pages/edit.jsp</value>
			</property>
		<property name="successfulPath"><value>/WEB-INF/command-pages/view.jsp</value>
			</property>
		<property name="previewPath">
			<value>/WEB-INF/command-pages/edit.jsp</value></property>
		<property name="cancelPath">
			<value>/WEB-INF/command-pages/view.jsp</value></property>
		<property name="objectService"><ref bean="objectService"/></property>		
	</bean>
	<bean id="commentSaveCommand"
		class="uk.ac.cam.caret.sakai.rwiki.tool.command.CommentSaveCommand">
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="noUpdatePath"><value>/WEB-INF/command-pages/permission.jsp</value>
		</property>
		<property name="contentChangedPath"><value>/WEB-INF/command-pages/edit.jsp</value>
		</property>
		<property name="successfulPath"><value>/WEB-INF/command-pages/view.jsp</value>
		</property>
		<property name="previewPath">
			<value>/WEB-INF/command-pages/edit.jsp</value></property>
		<property name="cancelPath">
			<value>/WEB-INF/command-pages/view.jsp</value></property>
		<property name="objectService"><ref bean="objectService"/></property>		
	</bean>
	<bean id="commentNewCommand"
		class="uk.ac.cam.caret.sakai.rwiki.tool.command.CommentNewCommand">
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="noUpdatePath"><value>/WEB-INF/command-pages/permission.jsp</value>
		</property>
		<property name="contentChangedPath"><value>/WEB-INF/command-pages/edit.jsp</value>
		</property>
		<property name="successfulPath"><value>/WEB-INF/command-pages/view.jsp</value>
		</property>
		<property name="previewPath">
			<value>/WEB-INF/command-pages/edit.jsp</value></property>
		<property name="cancelPath">
			<value>/WEB-INF/command-pages/view.jsp</value></property>
		<property name="objectService"><ref bean="objectService"/></property>		
	</bean>
	
	<!-- Update permissions command -->
	<bean id="updatePermissionsCommand" class="uk.ac.cam.caret.sakai.rwiki.tool.command.UpdatePermissionsCommand">
		<property name="noUpdatePath"><value>/WEB-INF/command-pages/permission.jsp</value></property>
		<property name="contentChangedPath"><value>/WEB-INF/command-pages/info.jsp</value></property>
		<property name="successfulPath"><value>/WEB-INF/command-pages/info.jsp</value></property>
		<property name="objectService"><ref bean="objectService"/></property>
	</bean>
	
	<!-- revert command -->
	<bean id="revertCommand"
		class="uk.ac.cam.caret.sakai.rwiki.tool.command.RevertCommand">
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="noUpdatePath"><value>/WEB-INF/command-pages/permission.jsp</value>
			</property>
		<property name="contentChangedPath"><value>/WEB-INF/command-pages/edit.jsp</value>
			</property>
		<property name="successfulPath"><value>/WEB-INF/command-pages/view.jsp</value>
			</property>
		<property name="objectService"><ref bean="objectService"/></property>
	</bean>
	
	<!-- Real/AuthZgroups edit command -->
	<bean id="editRealmCommand"
		class="uk.ac.cam.caret.sakai.rwiki.tool.command.EditAuthZGroupCommand">
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="realmService"><ref bean="org.sakaiproject.service.legacy.authzGroup.AuthzGroupService"/></property>
		<property name="cancelEditPath"><value>/WEB-INF/command-pages/info.jsp</value></property>
		<property name="editRealmPath"><value>/WEB-INF/command-pages/editRealm.jsp</value></property>
    	<property name="idInUsePath"><value>/WEB-INF/command-pages/realmIdInUse.jsp</value></property>
		<property name="permissionPath"><value>/WEB-INF/command-pages/permission.jsp</value></property>
		<property name="successfulPath"><value>/WEB-INF/command-pages/info.jsp</value></property>		
		<property name="unknownRealmPath"><value>/WEB-INF/command-pages/realmUnknown.jsp</value></property>		
	</bean>
	<!--<bean id="Command" class="uk.ac.cam.caret.sakai.rwiki.tool.command.Command">
	<property name="log"><ref bean="rwiki-logger"/></property>
	<property name="servletPath">/jrwiki/.jsp</property>
	<property name="populateService"><ref bean="populateService"/></property>
	<property name="renderBeanHelper"><ref bean="renderBeanHelper"/></property>
	<property name="rwikiObjectHelper"><ref bean="rwikiObjectHelper"/></property>
	<property name="viewBeanHelper"><ref bean="viewBeanHelper"/></property>
	<property name="userHelper"><ref bean="userHelper"/></property>
	</bean>-->
	
	<!-- The RWiki Transaction Manager, using the RWiki Session factory -->
	<bean id="uk.ac.cam.caret.sakai.rwiki.RWikiTransactionManager"
		class="org.springframework.orm.hibernate.HibernateTransactionManager">
		<property name="sessionFactory"><ref
				bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
			</property>
	</bean>
	
	<!-- 
	Pre populated pages,
	These are loaded into each space as it starts.
	You may add your own pages or edit the exiting pages.
	THe files are contain Wiki format pages
	The paths are in the classpath
	
	 -->
	
	<bean id="rwiki.seedPage.HelpPage"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiCurrentObjectImpl"
		init-method="init" singleton="true">
		<property name="name"><value>Help Page</value></property>
		
		<property name="source">
			<value>/uk/ac/cam/caret/sakai/rwiki/tool/bundle/HelpPage.txt</value>
		</property>
		
		<property name="ownerAdmin"><value>true</value></property>
		<property name="ownerRead"><value>true</value></property>
		<property name="ownerWrite"><value>true</value></property>
		<property name="groupAdmin"><value>false</value></property>
		<property name="groupRead"><value>true</value></property>
		<property name="groupWrite"><value>false</value></property>
		<property name="publicRead"><value>false</value></property>
		<property name="publicWrite"><value>false</value></property>
		
		<property name="rwikiObjectContentDao"><ref bean="rwikiCurrentObjectContentDaoImpl"/></property>
	</bean>
	
	<bean id="rwiki.seedPage.HomePage"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiCurrentObjectImpl"
		init-method="init" singleton="true">
		<property name="name"><value>Home</value></property>
		
		<property name="source">
			<value>/uk/ac/cam/caret/sakai/rwiki/tool/bundle/HomePage.txt</value>
		</property>
		
		<property name="ownerAdmin"><value>true</value></property>
		<property name="ownerRead"><value>true</value></property>
		<property name="ownerWrite"><value>true</value></property>
		<property name="groupAdmin"><value>false</value></property>
		<property name="groupRead"><value>true</value></property>
		<property name="groupWrite"><value>false</value></property>
		<property name="publicRead"><value>false</value></property>
		<property name="publicWrite"><value>false</value></property>
		
		<property name="rwikiObjectContentDao"><ref bean="rwikiCurrentObjectContentDaoImpl"/></property>
	</bean>
	
	<bean id="rwiki.seedPage.AboutCoursePage"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiCurrentObjectImpl"
		init-method="init" singleton="true">
		<property name="name"><value>About</value></property>
		
		<property name="source">
			<value>/uk/ac/cam/caret/sakai/rwiki/tool/bundle/AboutCoursePage.txt</value>
		</property>
		
		<!--
		This says site type starts with
		( not course and not project ) or ( myspecialtype ) or ( coursetype3 ) 
		If a match is found the page will get loaded into the site on site creation
		<property name="targetSiteTypes">
			<list>
				<value>!course,!project</value>
				<value>myspecialtype</value>
				<value>coursetype3</value>
			
			</list>
		</property>
		
		now for something a little simpler
		-->
		<property name="targetSiteTypes">
			<list>
				<value>course</value>
			</list>
		</property>
		
		<property name="ownerAdmin"><value>true</value></property>
		<property name="ownerRead"><value>true</value></property>
		<property name="ownerWrite"><value>true</value></property>
		<property name="groupAdmin"><value>false</value></property>
		<property name="groupRead"><value>true</value></property>
		<property name="groupWrite"><value>false</value></property>
		<property name="publicRead"><value>false</value></property>
		<property name="publicWrite"><value>false</value></property>
		
		<property name="rwikiObjectContentDao"><ref bean="rwikiCurrentObjectContentDaoImpl"/></property>
	</bean>
	
	<bean id="rwiki.seedPage.AboutProjectPage"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiCurrentObjectImpl"
		init-method="init" singleton="true">
		<property name="name"><value>About</value></property>

		<property name="targetSiteTypes">
			<list>
				<value>!course</value>
			</list>
		</property>
		
		<property name="source">
			<value>/uk/ac/cam/caret/sakai/rwiki/tool/bundle/AboutProjectPage.txt</value>
		</property>
		
		<property name="ownerAdmin"><value>true</value></property>
		<property name="ownerRead"><value>true</value></property>
		<property name="ownerWrite"><value>true</value></property>
		<property name="groupAdmin"><value>false</value></property>
		<property name="groupRead"><value>true</value></property>
		<property name="groupWrite"><value>false</value></property>
		<property name="publicRead"><value>false</value></property>
		<property name="publicWrite"><value>false</value></property>
		
		<property name="rwikiObjectContentDao"><ref bean="rwikiCurrentObjectContentDaoImpl"/></property>
	</bean>
	
	<!-- Second help page -->
	<bean id="rwiki.seedPage.HelpPagetwo"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiCurrentObjectImpl"
		init-method="init" singleton="true">
		<property name="name"><value>HelpPagetest</value></property>
		
		<property name="source">
			<value>/uk/ac/cam/caret/sakai/rwiki/tool/bundle/HelpPage.txt</value>
		</property>
		
		<property name="ownerAdmin"><value>true</value></property>
		<property name="ownerRead"><value>true</value></property>
		<property name="ownerWrite"><value>true</value></property>
		<property name="groupAdmin"><value>false</value></property>
		<property name="groupRead"><value>true</value></property>
		<property name="groupWrite"><value>false</value></property>
		<property name="publicRead"><value>true</value></property>
		<property name="publicWrite"><value>false</value></property>
		<property name="rwikiObjectContentDao"><ref bean="rwikiCurrentObjectContentDaoImpl"/></property>
		
	</bean>
	<!-- this is the default page template for new pages -->
	<bean id="rwiki.seedPage.DefaultTemplate"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiCurrentObjectImpl"
		init-method="init" singleton="true">
		<property name="name"><value>default_template</value></property>
		
		<property name="source">
			<value>/uk/ac/cam/caret/sakai/rwiki/tool/bundle/DefaultPageTemplate.txt</value>
		</property>
		
		<property name="ownerAdmin"><value>true</value></property>
		<property name="ownerRead"><value>true</value></property>
		<property name="ownerWrite"><value>true</value></property>
		<property name="groupAdmin"><value>true</value></property>
		<property name="groupRead"><value>true</value></property>
		<property name="groupWrite"><value>true</value></property>
		<property name="publicRead"><value>false</value></property>
		<property name="publicWrite"><value>false</value></property>
		<property name="rwikiObjectContentDao"><ref bean="rwikiCurrentObjectContentDaoImpl"/></property>
		
	</bean>
	
	<!-- Page containing recent changes macro -->
	<bean id="rwiki.seedPage.RecentChangesPage"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiCurrentObjectImpl"
		init-method="init" singleton="true">
		<property name="name"><value>Recent Changes</value></property>
		
		<property name="source">
			<value>/uk/ac/cam/caret/sakai/rwiki/tool/bundle/RecentChanges.txt</value>
		</property>
		
		<property name="ownerAdmin"><value>true</value></property>
		<property name="ownerRead"><value>true</value></property>
		<property name="ownerWrite"><value>true</value></property>
		<property name="groupAdmin"><value>false</value></property>
		<property name="groupRead"><value>true</value></property>
		<property name="groupWrite"><value>false</value></property>
		<property name="publicRead"><value>true</value></property>
		<property name="publicWrite"><value>false</value></property>
		<property name="rwikiObjectContentDao"><ref bean="rwikiCurrentObjectContentDaoImpl"/></property>
		
	</bean>
	<!-- Right side bar on the edit page -->
		<bean id="rwiki.seedPage.EditRightPage"
			class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiCurrentObjectImpl"
		init-method="init" singleton="true">
		<property name="name"><value>Edit_right</value></property>
		
		<property name="source">
			<value>/uk/ac/cam/caret/sakai/rwiki/tool/bundle/EditRight.txt</value>
		</property>
		
		<property name="ownerAdmin"><value>true</value></property>
		<property name="ownerRead"><value>true</value></property>
		<property name="ownerWrite"><value>true</value></property>
		<property name="groupAdmin"><value>false</value></property>
		<property name="groupRead"><value>true</value></property>
		<property name="groupWrite"><value>false</value></property>
		<property name="publicRead"><value>true</value></property>
		<property name="publicWrite"><value>false</value></property>
		<property name="rwikiObjectContentDao"><ref bean="rwikiCurrentObjectContentDaoImpl"/></property>
			
	</bean>

	<!-- The base level radeox render engine -->

	<bean id="baseRenderEngine" class="uk.ac.cam.caret.sakai.rwiki.component.radeox.service.impl.RWikiBaseRenderEngine" init-method="init">
		<property name="log"><ref bean="rwiki-logger"/></property>
	</bean>


		
		<!-- The Rendered content cache, impl uses ehcache which is initialised on first use, if cache fails
		it is re-initialised -->
	<bean id="rwikiRenderCache" class="uk.ac.cam.caret.sakai.rwiki.component.radeox.service.impl.RenderCacheImpl" 
		 init-method="init" >
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="cacheName"><value>rwiki-render-cache</value></property>
	</bean>
	
		
		<!-- Database storage for properties site wide -->
	<bean id="rwikiPropertyDao"
		class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
		<property name="transactionManager"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiTransactionManager"/>
		</property>
		<property name="transactionAttributes">
			<props>
				<prop key="update*">PROPAGATION_REQUIRED</prop>
				<prop key="delete*">PROPAGATION_REQUIRED</prop>
			</props>
		</property>
		<property name="target"><ref bean="rwikiPropertyDaoImpl"/></property>
	</bean>
	<!-- DAO for current Object, acessed via Transaction Proxy -->
	<bean id="rwikiPropertyDaoImpl"
		class="uk.ac.cam.caret.sakai.rwiki.component.dao.impl.RWikiPropertyDaoImpl"
		singleton="true">
		<property name="sessionFactory"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
		</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
	</bean>
	
	
	<!-- Data migration access proxy -->
	<bean id="rwikiDataMigration"
		class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
		<property name="transactionManager"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiTransactionManager"/>
		</property>
		<property name="transactionAttributes">
			<props>
				<prop key="update*">PROPAGATION_REQUIRED</prop>
			</props>
		</property>
		<property name="target"><ref bean="rwikiDataMigrationImpl"/></property>
	</bean>
	
	<!-- Data migration sepecification, containing the steps to get the target schema -->
	<bean id="rwikiDataMigrationImpl" 
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.DataMigrationSpecification" >
		<property name="targetVersion"  ><ref bean="rwikiCurrentSchemaVersion" /></property>
		<property name="migrationAgents">
			<list>
				<ref bean="rwiki-data-migrate-noneTo20051017" />
				<ref bean="rwiki-data-migrate-applyCurrentSHA1" />
				<ref bean="rwiki-data-migrate-applyHistorySHA1" />
				<ref bean="rwiki-data-migrate-noneTo20051026" />
				<ref bean="rwiki-data-migrate-20051026To20051107" />
			</list>
		</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="propertyDao"><ref bean="rwikiPropertyDaoImpl" /></property>
	</bean>
	
	<!-- propery prototype for the target schema version -->
	<bean id="rwikiCurrentSchemaVersion" 
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.RWikiPropertyImpl">
		<property name="name"><value>schema-version</value></property>
		<property name="value"><value>20051107</value></property>
	</bean>
	
	<!-- data migration step from null to version 20051017 step 1, split of current and history ojects, and explicit content lazy load -->
	<bean id="rwiki-data-migrate-noneTo20051017"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.SQLScriptMigration" >
		<property name="to"><value>20051017-S1</value></property>
		<property name="scriptPattern">
			<value>/uk/ac/cam/caret/sakai/rwiki/model/bundle/{0}/migrateTo20051017.sql</value>			
		</property>
		<property name="sessionFactory"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
		</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
	</bean>
	
	<!-- computation for the current objects, migrates from 20051017-S1 to 20051017-S2 -->
	<bean id="rwiki-data-migrate-applyCurrentSHA1"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.SHAHashMigration" >
		<property name="from"><value>20051017-S1</value></property>
		<property name="to"><value>20051017-S2</value></property>
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="rwikiObjectDao"><ref bean="rwikiCurrentObjectDaoImpl"/></property>
	</bean>
	<!-- computation for the current objects, migrates from 20051017-S2 to 20051017 -->
	<bean id="rwiki-data-migrate-applyHistorySHA1"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.SHAHashMigration" >
		<property name="from"><value>20051017-S2</value></property>
		<property name="to"><value>20051017</value></property>
		<property name="log"><ref bean="rwiki-logger"/></property>
		<property name="rwikiObjectDao"><ref bean="rwikiHistoryObjectDaoImpl"/></property>
	</bean>
	<!-- schema migration 20051017 to 20051026, oracle user to userid -->
	<bean id="rwiki-data-migrate-noneTo20051026"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.SQLScriptMigration" >
		<property name="from"><value>20051017</value></property>
		<property name="to"><value>20051026</value></property>
		<property name="scriptPattern">
			<value>/uk/ac/cam/caret/sakai/rwiki/model/bundle/{0}/migrateTo20051026.sql</value>			
		</property>
		<property name="sessionFactory"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
		</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
	</bean>
	<!-- schema migration 20051026 to 20051107, change the subspace separator to / -->
	<bean id="rwiki-data-migrate-20051026To20051107"
		class="uk.ac.cam.caret.sakai.rwiki.component.model.impl.SQLScriptMigration" >
		<property name="from"><value>20051026</value></property>
		<property name="to"><value>20051107</value></property>
		<property name="scriptPattern">
			<value>/uk/ac/cam/caret/sakai/rwiki/model/bundle/{0}/migrateTo20051107.sql</value>			
		</property>
		<property name="sessionFactory"><ref
			bean="uk.ac.cam.caret.sakai.rwiki.RWikiSessionFactory"/>
		</property>
		<property name="log"><ref bean="rwiki-logger"/></property>
	</bean>
</beans>
