##<!-- $Header: /cvs/sakai/chef-tool/src/webapp/vm/discussion/chef_threaded_discussionsII-Control.vm,v 1.5 2004/10/01 01:19:21 janderse.umich.edu Exp $ -->
#* Zhen - I think this is good to go.
One thing remaining is the toolbar vs messagebar - the toolbar should only show when looking at an item, not editing, nor creating. In fact, if you hit reply while creating a topic you get an error. I have "sketched" the logic needed below...*#

<div class="chefPortletContainer">
	#if($menu)#toolbar($menu)#end

#*
# if (am looking at an item)	
		You are looking at an item - output toolbar 
#else	
	<div class ="chefPortletToolBarMessage">
				#if ($creating new topic)
					Creating topic...
				#elseif ($creating new category)
					Creating category...
				#elseif ($deleting a category)
					Deleting category...
				#elseif ($deleting a topic)
					Deleting topic...
				#elseif ($deleting a draft response)
					Deleting draft response....
				#elseif ($deleting a draft item)
					Deleting posted item....
				#else (anythng else I may have forgotten)
						Anything else...	
				#end
		</div>
 *#

## this is double deep
<script type="text/javascript" language="JavaScript">
doubleDeep = true;
</script>

	<div class="chefPortletContent">
		#if ($alertMessage)<div class="chefAlertBox">Alert: $validator.escapeHtml($alertMessage)</div>#end
		#set ($form="controlform")
		#set($id = $!currentMessage.getId())
		#if ($!id.length()>0)
			#set ($category = $currentMessage.getDiscussionHeader().getCategory())
			#set ($starOrThread = "thread")
			#set ($props = $topic.getProperties())
			#if ($!props)
				#set ($starOrThread = $props.getProperty($props.getNamePropReplyStyle()))
			#end
			#if ($currentMessage.getDiscussionHeader().getDraft())
				<script type="text/javascript">
					focus_path = [ "subject" ];
					if (parent) if (parent.parent) parent.parent.window.scrollTo(0,400);
				</script>
				<form action="#toolForm($action)" method="post">
					<fieldset style="display:block; clear:both" >
						<legend>
							Draft message
						</legend>
						<input type="hidden" name="messageId" value="$id" />
						<table class="chefEditItem" summary="This table contains the information for a draft message">	
							<tr>
								<td class="chefLabel">
									Category: 
								</td>
								<td>
									$validator.escapeHtml($draftCategory)
								</td>
							</tr>
							#if ($currentMessage.ReplyToDepth != 0)
								<tr>
									<td class="chefLabel">
										Topic: 
									</td>
									<td>
										$topic.getDiscussionHeader().getSubject()
									</td>
								</tr>
							#end
							<tr>
								<td class="chefLabel">
									#if ($currentMessage.ReplyToDepth != 0)
										Subject:
									#else
										Topic:
									#end
								</td>
								<td>
									<input type="text" name ="subject" id ="subject" value="$validator.escapeHtml($draftSubject)" />
								</td>
							</tr> 
							<tr>
								<td class="chefLabel">
									From:
								</td>
								<td>
									$validator.escapeHtml($currentMessage.getDiscussionHeader().getFrom().getDisplayName())
								</td>
							</tr> 
							<tr>
								<td class="chefLabel">
									Date:
								</td>
								<td>
									$currentMessage.getDiscussionHeader().getDate().toStringLocalFull()
								</td>
							</tr>
							<tr>
								<td class="chefLabel">
									Message:
								</td>
								<td>
									<table border="0"><tr><td>
									<textarea name = "body" id = "body" cols="80" rows="15" wrap="virtual">$validator.escapeHtmlFormattedTextarea($draftBody)</textarea>
									#chef_setupformattedtextarea("body")
									</td></tr></table>
								</td>
							</tr>
							<tr>
								<td class="chefLabel">
									Reply type:
								</td>
								<td>
									#if ($currentMessage.getReplyToDepth()==0)
										#if ($draftStyle.equals("thread"))
											<input type="radio" name="style" value="thread" checked="checked" id="styleThread" /><label for="styleThread">Allow reply to any message</label><br />
											<input type="radio" name="style" value="star" id="styleStar" /><label for="styleStar">Allow reply to topic only</label>
										#else
											<input type="radio" name="style" value="thread" /><label for="styleThread">Allow reply to any message</label><br />
											<input type="radio" name="style" value="star" checked="checked" id="styleStar"  /><label for="styleStar">Allow reply to topic only</label>
										#end
									#else
										#if ($starOrThread == "thread")
											Allow reply to any message
										#else
											Allow reply to topic only
										#end
									#end
								</td>
							</tr>						
							<tr>
								<td class="chefLabel">
									Attachments:
								</td>
								<td>
									<fieldset class="chefAttachmentsF">
										<legend class="chefAttachmentsL">	
											Attachments
										</legend> 
										#set ($size = 0)
										#set ($props = false)
										#foreach ($attachment in $attachments) 
											#set ($props = $attachment.Properties) 
											#if ($!props)
												#set ($size = $size + 1)
											#end
										#end
										#if ($size == 0)
											No attachments ...
											<div class="chefButtonRow">
												<input type="submit" name="eventSubmit_doAttachments" value="Add attachments" />
											</div>
										#else
											<ul class="chefAttachmentList">
												#foreach ($attachment in $attachments) 
													#set ($props = false)
													#set ($props = $attachment.Properties) 
													#if ($!props)
														<li>
															#if ($props.getBooleanProperty($props.NamePropIsCollection))
																<img src = "#imageLink($contentTypeImageService.getContentTypeImage("folder"))" border="0" alt="folder attachment" />
															#else
																<img src = "#imageLink($contentTypeImageService.getContentTypeImage($props.getProperty($props.NamePropContentType)))" border="0" alt="File attachment" />
															#end
															<a href="$attachment.Url" target="_blank">$validator.escapeHtml($props.getPropertyFormatted($props.NamePropDisplayName))</a>						
															#if (!$props.getBooleanProperty($props.NamePropIsCollection))
																($props.getPropertyFormatted($props.NamePropContentLength))
															#end
														</li>
													#end
												#end
											</ul>
											<div class="chefButtonRow">
												<input type="submit" name="eventSubmit_doAttachments" value="Add/remove attachments" />
											</div>
										#end							
									</fieldset>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<div class="chefButtonRow">
										<input type="submit" name="eventSubmit_doPost" value="Post" />
										<input type="submit" name="eventSubmit_doSave" value="Save Draft" />
										<input type="submit" name="eventSubmit_doCancel_draft" value="Cancel" />
									</div>
								</td>
							</tr>
						</table>
					</fieldset>
				</form>
			#else
				## a posted message
				
				<div class ="chefBreadCrumb">
					$validator.escapeHtml($category) &gt; $topic.getDiscussionHeader().getSubject() &gt; $validator.escapeHtml($currentMessage.getDiscussionHeader().getSubject())
				</div>
				<table class="chefItemDetail" cellspacing="0" summary="The posted message infos">
#* 					<tr>
						<td class="chefLabel">
							Category:
						</td>
						<td>
							$validator.escapeHtml($category)
						</td>
					</tr>
					<tr>
						<td class="chefLabel">
							Topic: 
						</td>
						<td>
							$topic.getDiscussionHeader().getSubject()
						</td>
					</tr>
					<tr>
						<td class="chefLabel">
							Subject:
						</td>
						<td>
							$validator.escapeHtml($currentMessage.getDiscussionHeader().getSubject())
						</td>
					</tr> 
 *#
					<tr>
						<td class="chefLabel">
							From:
						</td>
						<td>
							$validator.escapeHtml($currentMessage.getDiscussionHeader().getFrom().getDisplayName()) ($currentMessage.getDiscussionHeader().getDate().toStringLocalFull())
						</td>
					</tr> 
#* 					<tr>
						<td class="chefLabel">
							Date:
						</td>
						<td>
							$currentMessage.getDiscussionHeader().getDate().toStringLocalFull()
						</td>
					</tr>
 *#
				#* 	<tr>
						<td class="chefLabel">
							Reply type:
						</td>
						<td>
							#if ($starOrThread == "thread")
								Allow reply to any message
							#else
								Allow reply to topic only
							#end
						</td>
					</tr>
					<tr> *#
					<tr>
						<td class="chefLabel">
							Message:
						</td>
						<td>
							<span class="chefPre">$validator.escapeHtmlFormattedText($currentMessage.getBody())</span>
						</td>
					</tr>
					#set ($size = 0)
					#set ($props = false)
					#foreach ($attachment in $currentMessage.Header.Attachments) 
						#set ($props = $attachment.Properties) 
						#if ($!props)
							#set ($size = $size + 1)
						#end
					#end
					#if ($size != 0)
						<tr>
							<td class="chefLabel">
								Attachments:
							</td>
							<td>
								<ul class="chefAttachmentList">
									#foreach ($attachment in $currentMessage.Header.Attachments) 
										#set ($props = false)
										#set ($props = $attachment.Properties) 
										#if ($!props)
											<li>
												#if ($props.getBooleanProperty($props.NamePropIsCollection))
													<img src = "#imageLink($contentTypeImageService.getContentTypeImage("folder"))" border="0" alt="folder attachment" />
												#else
													<img src = "#imageLink($contentTypeImageService.getContentTypeImage($props.getProperty($props.NamePropContentType)))" border="0" alt="File attachment" />
												#end
												<a href="$attachment.Url" target="_blank">$validator.escapeHtml($props.getPropertyFormatted($props.NamePropDisplayName))</a>						
												#if (!$props.getBooleanProperty($props.NamePropIsCollection))
													($props.getPropertyFormatted($props.NamePropContentLength))
												#end
											</li>
										#end
									#end
								</ul>
							</td>
						</tr>
					#end
					<tr>
						<td class="chefLabel">
							<form action="#toolForm($action)" method="post">
								<div class="chefButtonRow">
									<input type="submit" name="eventSubmit_doSet_reply" value="Reply" />
								</div>
							</form>
						</td>
						<td align="right">
						</td>
					</tr>
				</table>
			#end
		#else
			<form action="#toolForm($action)" method="post">
			</form>
		#end
	</div>
</div>
