##<!-- $Header: /cvs/sakai/chef-tool/src/webapp/vm/discussion/chef_threaded_discussionsII-List.vm,v 1.7 2004/09/09 18:26:28 zqian.umich.edu Exp $ -->
<script  type="text/javascript" language="JavaScript" src="#scriptLink("discussionscript.js")">
</script>

## this is double deep
<script type="text/javascript" language="JavaScript">
doubleDeep = true;
</script>
<div class="chefPortletContainer">
	<div class="chefPortletContent">
		<span class="chefAlert">
			#if ($searching)
				#if ($searchResultList.size()>0)
					#if ($searchResultList.size() == 1)
						1 item was found that matches your search.
					#else
						$searchResultList.size() items were found that match your search.
					#end
				#else 
					No items were found that match your search. Please try to revise your search.
				#end
				<br />
			#end
		</span>
		#if ($alertMessage)<div class="chefAlertBox">Alert: $validator.escapeHtml($alertMessage)</div>#end
		#if ($!categories)
			<table width="100%" border="0" cellspacing="0" cellpadding="3">
			#foreach ($category in $categories)
				<tr bgcolor="#E1E1E1">
					<td width="4%">
						#if (!$expandedCategoryList.contains($category))
							<a href="#" onclick="location='#toolLink($action "doExpand_category")&category=$validator.escapeUrl($category)'; return false;">
								<img src = "#imageLink("chef/expand.gif")" border="0" alt="expand" /></a> 
						#else
							<a href="#" onclick="location='#toolLink($action "doCollapse_category")&category=$validator.escapeUrl($category)'; return false;">
								<img src = "#imageLink("chef/collapse.gif")" border="0" alt="Collapse" /></a> 
						#end
					</td>
					<td nowrap="nowrap">
						$validator.escapeHtml($category)
						#if ($allow_remove_category)
							<a href="#" onclick="location='#toolLink($action "doDelete_category_confirm")&category=$validator.escapeUrl($category)'; return false;" title="Delete this category" >				
								<img src = "#imageLink("chef/delete.gif")" border="0" alt ="Delete this category" /></a>
						#end
						
					</td>
				</tr>
				#if ($expandedCategoryList.contains($category))
					## show messages inside the category if the category has been expanded
					#set ($topicId = "")
					#set ($messages = $categoriesShowList.get($category))
					#set ($expandedMessages = $expandedMessageList.get($category))
					#if ($!messages.size()>0)
						#foreach ($messageId in $messages)
							#set ($message = $channel.getDiscussionMessage($messageId))
							##if message is not null
							#if ($!message)
								#set ($category = $message.getDiscussionHeader().getCategory())
								#set($depth=$message.getReplyToDepth())
								#set ($replyNumber= $channel.getThreadNumberOfReplies($message))
								#set ($topicId = $message.getId())
								<tr   #if ($searchResultList.indexOf($message.Id) != -1) style="background-color:#FFFF00"#end >
									<td valign="bottom" style="white-space: nowrap;" width="4%">
										#if ($currentMessage.Id == $message.Id)
											<img src = "#imageLink("chef/arrowhere.gif")" border="0" alt="Current message"/>
										#else
											&nbsp;
										#end
									</td>
									<td colspan="5" align="left" nowrap="nowrap">
										#set ($text = "")
										#if ($depth>0)
											#foreach ($j in [1..$depth])
												&nbsp;&nbsp;
											#end
										#end
										#if ($replyNumber>0)
											#if (!$expandedMessages.contains($message))
												<a href="#" onclick="location='#toolLink($action "doExpand_message")&messageId=$message.Id'; return false;" title="Expand"><img src = "#imageLink("chef/expand.gif")" border="0" alt="Expand" /></a>					
											#else
												<a href="#" onclick="location='#toolLink($action "doCollapse_message")&messageId=$message.Id'; return false;" title="Collapse"><img src = "#imageLink("chef/collapse.gif")" border="0" alt="Collapse" /></a>					
											#end
										#else
											&nbsp;&nbsp;&nbsp;
										#end
										#if ($visitedMessages.contains($message.id))
											#if ($currentMessage.Id == $message.Id)
												<span style="font-weight:bold">
													<a id="$validator.escapeJavascript($message.id)" href="#" onclick="location='#toolLink($action "doShow")&messageId=$message.Id'; return false;">#if ($message.getDiscussionHeader().getDraft())<span class="chefAlert">Draft - </span>#end
														$validator.limit($validator.escapeHtml($message.getDiscussionHeader().getSubject()), 50)
													</a>
												</span>
											#else
												<a id="$validator.escapeJavascript($message.id)" href="#" onclick="location='#toolLink($action "doShow")&messageId=$message.Id'; return false;">#if ($message.getDiscussionHeader().getDraft())<span class="chefAlert">Draft - </span>#end
													$validator.limit($validator.escapeHtml($message.getDiscussionHeader().getSubject()), 50)
												</a>
											#end
											#set ($size = $message.Header.Attachments.size())
											#set ($props = false)
											#if (!$message.Header.Attachments.isEmpty())
												#foreach ($attachment in $attachments)
													#set ($props = $attachment.Properties) 
													#if ($!props)
														#set ($size = $size + 1)
													#end
												#end
											#end
											<span style="font-size:.8em">
											#if ($replyNumber>0)
												#if ($replyNumber==1) 
													(1 response)
												#else
													($replyNumber responses)
												#end
											#end
											#set($lastestMessage=false)
											#set($lastestMessage = $channel.getThreadLatestReply($message))
											## always show the "created by" not "last modified by"
											$validator.escapeHtml($message.getDiscussionHeader().getFrom().getDisplayName())
											$message.getDiscussionHeader().getDate().toStringLocalFull()
											</span>
											#if ($size > 0)
												<img src = "#imageLink("chef/attachments.gif")" border="0" alt="Has attachments" />
											#end
											#if ($depth==0)
												<a href="#" onclick="location='#toolLink($action "doShow_topic_content")&topicId=$message.Id'; return false;"  title="Show the content of the topic">
												<img src = "#imageLink("chef/content.gif")" border="0" alt="Printer-friendly view" />
												</a>
											#end
											#if ($channel.allowRemoveMessage($message))
												<a href="#" onclick="location='#toolLink($action "doDelete_message_confirm")&messageId=$message.Id'; return false;" title="Delete this message">				
													<img src = "#imageLink("chef/delete.gif")" border="0" alt="Delete this message" /></a>
											#end
										#else
											<span style="font-weight:bold">
												<a id="$validator.escapeJavascript($message.id)" href="#" onclick="location='#toolLink($action "doShow")&messageId=$message.Id'; return false;">#if ($message.getDiscussionHeader().getDraft())<span class="chefAlert">Draft - </span>#end
													$validator.limit($validator.escapeHtml($message.getDiscussionHeader().getSubject()), 50)
												</a>
											</span>
											#set ($size = $message.Header.Attachments.size())
											#set ($props = false)
											#if (!$message.Header.Attachments.isEmpty())
												#foreach ($attachment in $attachments)
													#set ($props = $attachment.Properties) 
													#if ($!props)
														#set ($size = $size + 1)
													#end
												#end
											#end
											<span style="font-size:.8em">
											#if ($replyNumber>0)
												#if ($replyNumber==1) 
													(1 response)
												#else
													($replyNumber responses)
												#end
											#end
											#set($lastestMessage=false)
											#set($lastestMessage = $channel.getThreadLatestReply($message))
											## always show the "created by" not "last modified by"
											$validator.escapeHtml($message.getDiscussionHeader().getFrom().getDisplayName())
											$message.getDiscussionHeader().getDate().toStringLocalFull()</span>
											#if ($size > 0)
												<img src = "#imageLink("chef/attachments.gif")" border="0" alt="Has attachments" />
											#end
											#if ($depth==0)
												<a href="#" onclick="location='#toolLink($action "doShow_topic_content")&topicId=$message.Id'; return false;"  title="Show the content of the topic">
												<img src = "#imageLink("chef/content.gif")" border="0" alt="Show the content of this topic" />
												</a>
											#end
											#if ($channel.allowRemoveMessage($message))
												<a href="#" onclick="location='#toolLink($action "doDelete_message_confirm")&messageId=$message.Id'; return false;" title="Delete this message">
													<img src = "#imageLink("chef/delete.gif")" border="0" alt="Delete this message" /></a>
											#end
										#end
									</td>
								</tr>
							#end
						#end	##	if
					#end
				#end
			#end
			</table>
		#else
			No discussion items currently.
		#end
		#set ( $idString = $validator.escapeJavascript($currentMessage.Id))
		<script type="text/javascript">
			scroll("$idString");
		</script>
	</div>
</div>