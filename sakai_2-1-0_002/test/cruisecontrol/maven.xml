<?xml version="1.0" encoding="UTF-8"?>

<project
	xmlns:maven="jelly:maven">

<goal name="cruisecontrolloop">
	<attainGoal name="clean" />
	<attainGoal name="cleanmavenrepository" />
	<attainGoal name="checkout" />
	<attainGoal name="removeextraclean" />
	<attainGoal name="build" />
</goal>


<!-- Ret rid of any Sakai artifacts in the local Maven repository,
	so that they are cleanly rebuilt.
-->
<goal name="cleanmavenrepository">
	<delete dir="${maven.repo.local}/sakai" />
	<delete dir="${maven.repo.local}/sakaiproject" />
</goal>

<!-- Checkout fresh Sakai source -->
<goal name="checkout">
	<attainGoal name="scm:checkout" />
</goal>


<!-- Remove an extra "clean" goal in Sakai's Maven.xml -
	removes the line '<attainGoal name="sakai:clean" />' from Sakai's build.
	This is not strictly necessary, it just makes the build go faster.
-->
<goal name="removeextraclean">
	<copy 
		overwrite="true"
		file="${basedir}/target/checkout/maven.xml"
		tofile="${basedir}/target/checkout/maven-cruisecontrol.xml"
	>
		<filterset begintoken="&lt;attainGoal name=&quot;" endtoken="&quot; /&gt;">
			<filter value="" token="sakai:clean" />
		</filterset>
	</copy>
	<copy 
		overwrite="true"
		file="${basedir}/target/checkout/maven-cruisecontrol.xml"
		tofile="${basedir}/target/checkout/maven.xml" />

</goal>

<!-- Builds Sakai and creates a standalone demo ZIP as the resulting CruiseControl artifact -->
<goal name="build">
	<maven:maven descriptor="target/checkout/project.xml"
		goals="pack-demo" />	
</goal>
</project>
