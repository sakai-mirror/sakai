<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping
    PUBLIC "-//Hibernate/Hibernate Mapping DTD//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-2.0.dtd">

<hibernate-mapping>

  <class
    name="org.sakaiproject.component.common.superstructure.NodeImpl"
    table="CMN_NODE_T" optimistic-lock="version">

    <cache usage="read-write" />

    <!-- Persistable fields -->
    <id name="id">
      <column name="ID" not-null="true" length="19" />
      <generator class="native">
        <param name="sequence">CMN_NODE_S</param>
      </generator>
    </id>

    <version name="version" column="VERSION" />

    <property name="uuid" column="UUID" length="36" unique="true"
      not-null="true" />
    <property name="lastModifiedBy" column="LAST_MODIFIED_BY"
      length="36" not-null="true" />
    <property name="lastModifiedDate" column="LAST_MODIFIED_DATE"
      not-null="true" />
    <property name="createdBy" column="CREATED_BY" length="36"
      not-null="true" />
    <property name="createdDate" column="CREATED_DATE" not-null="true" />

    <!-- TypeablePersistable fields -->
    <many-to-one name="type" column="TYPE"
      class="org.sakaiproject.component.common.type.TypeImpl"
      not-null="true" index="CMN_NODE_TYPE_I" />

    <!-- Node fields -->
    <property name="referenceUuid">
      <column name="REFERENCE_UUID" length="36" unique="true"
        not-null="true" index="CMN_NODE_REFERENCE_UUID_I" />
    </property>

    <property name="displayName">
      <column name="DISPLAY_NAME" length="255" not-null="true"
        index="CMN_NODE_DISPLAY_NAME_I" />
    </property>

    <property name="description">
      <column name="DESCRIPTION" length="255" not-null="false" />
    </property>

    <!--  FIXME - not-null should be true -->
    <property name="depth">
      <column name="DEPTH" unique="false" not-null="true"
        index="CMN_NODE_DEPTH_I" />
    </property>

    <!-- Parent can be null for root categories. -->
    <many-to-one name="parent" column="PARENT_ID"
      class="org.sakaiproject.component.common.superstructure.NodeImpl"
      not-null="false" index="CMN_NODE_PARENT_I" cascade="none" />

    <!-- We use a Set for this bidirectional one-to-many. -->
    <set name="children" cascade="all-delete-orphan" inverse="true"
      lazy="true">
      <cache usage="read-write" />
      <key column="PARENT_ID" />
      <one-to-many
        class="org.sakaiproject.component.common.superstructure.NodeImpl" />
    </set>

  </class>

  <query name="getNodeById">
    <![CDATA[from org.sakaiproject.component.common.superstructure.NodeImpl ni where ni.id = :id]]>
  </query>

  <query name="getNodeByUuid">
    <![CDATA[from org.sakaiproject.component.common.superstructure.NodeImpl ni where ni.uuid = :uuid]]>
  </query>

  <query name="joinNodeAndMapForParent">
    <![CDATA[select ni from org.sakaiproject.component.common.superstructure.NodeImpl ni, NodeParentChildMapImpl pc where pc.parent = :parent and ni.id = pc.child]]>
  </query>

  <query name="joinNodeAndMapForChild">
    <![CDATA[select ni from org.sakaiproject.component.common.superstructure.NodeImpl ni, NodeParentChildMapImpl pc where pc.child = :child and ni.id = pc.parent]]>
  </query>

  <query name="idJoinNodeAndMapForChild">
    <![CDATA[select ni.uuid from org.sakaiproject.component.common.superstructure.NodeImpl ni, NodeParentChildMapImpl pc where pc.child = :child and ni.id = pc.parent]]>
  </query>

  <query name="findRootNodes">
    <![CDATA[from org.sakaiproject.component.common.superstructure.NodeImpl ni where ni.parent is null]]>
  </query>

</hibernate-mapping>
