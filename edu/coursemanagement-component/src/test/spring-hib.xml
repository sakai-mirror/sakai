<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
  <bean id="courseManagementPropertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="locations">
      <list>
        <value>classpath:/hibernate.properties</value>
      </list>
    </property>
  </bean>

  <bean id="courseManagementTransactionManager" class="org.springframework.orm.hibernate.HibernateTransactionManager">
    <property name="sessionFactory"><ref bean="courseManagementSessionFactory"/></property>
  </bean>

  <bean id="courseManagementSessionFactory" class="org.springframework.orm.hibernate.LocalSessionFactoryBean">
    <property name="dataSource"><ref bean="courseManagementDataSource"/></property>
    <property name="mappingResources">
      <list>
        <value>org/sakaiproject/component/common/edu/coursemanagement/CanonicalCourseStatusType.hbm.xml</value>
        <value>org/sakaiproject/component/common/edu/coursemanagement/Session.hbm.xml</value>
        <value>org/sakaiproject/component/common/edu/coursemanagement/SessionType.hbm.xml</value>
      </list>
    </property>
    
    <property name="hibernateProperties">
      <props>
        <prop key="hibernate.dialect">${hibernate.dialect}</prop>
        <prop key="hibernate.show_sql">${hibernate.show_sql}</prop>
        <prop key="hibernate.query.substitutions">true 1, false 0</prop>
        <prop key="hibernate.hbm2ddl.auto">false</prop>
      </props>
    </property>
  </bean>

  <bean id="autoProxyCreator"
    class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator">
    <property name="interceptorNames">
      <list>
        <idref bean="matchNameTxInterceptor" />
      </list>
    </property>

    <!-- Do not apply transactions during testing -->
    <property name="beanNames">
      <list>
      </list>
    </property>
  </bean>

  <bean id="matchNameTxInterceptor"
    class="org.springframework.transaction.interceptor.TransactionInterceptor">
    <property name="transactionManager">
      <ref bean="courseManagementTransactionManager" />
    </property>
    <property name="transactionAttributeSource">
      <ref bean="matchNameWithPropReq" />
    </property>
  </bean>

  <bean id="matchNameWithPropReq"
    class="org.springframework.transaction.interceptor.NameMatchTransactionAttributeSource">
    <property name="properties">
      <props>
        <prop key="add*">PROPAGATION_REQUIRED</prop>
        <prop key="create*">PROPAGATION_REQUIRED</prop>
        <prop key="update*">PROPAGATION_REQUIRED</prop>
        <prop key="remove*">PROPAGATION_REQUIRED</prop>
        <prop key="*">PROPAGATION_REQUIRED,readOnly</prop>
      </props>
    </property>
  </bean>

</beans>
