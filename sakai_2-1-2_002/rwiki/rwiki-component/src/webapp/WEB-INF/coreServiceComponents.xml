<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
  <!-- components context -->

  <!-- Render Factory for creating Wiki Renderer Contexts -->
  <bean id="renderContextFactory"
    class="uk.ac.cam.caret.sakai.rwiki.component.radeox.service.impl.RenderContextFactoryImpl">
    <property name="log"><ref bean="rwiki-logger"/></property>

    <property name="objectService"><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RWikiObjectService"/></property>
    <property name="securityService"><ref bean="securityService"/></property>
  </bean>

  <!-- Wiki engine factory -->
  <bean id="renderEngineFactory"
    class="uk.ac.cam.caret.sakai.rwiki.component.radeox.service.impl.RenderEngineFactoryImpl">
    <property name="log"><ref bean="rwiki-logger"/></property>

    <property name="objectService"><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RWikiObjectService"/></property>
    <property name="renderEngine"><ref bean="baseRenderEngine"/></property>
    <property name="externalImageLink"><value>&lt;img src="/library/image/sakai/url.gif" alt="external link: " title="external link"/&gt;</value></property>
  </bean>


  <bean id="securityService"
    class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.RWikiSecurityServiceImpl"
    init-method="init" >
    <property name="log"><ref bean="rwiki-logger"/></property>

    <property name="portalService"><ref
	bean="org.sakaiproject.service.framework.portal.PortalService" />
    </property>
    <property name="securityService"><ref
	bean="org.sakaiproject.service.legacy.security.SecurityService"/>
    </property>
    <property name="siteService"><ref
	bean="org.sakaiproject.service.legacy.site.SiteService"/>
    </property>
  </bean>

  <!-- The component level Render service -->
  <bean id="uk.ac.cam.caret.sakai.rwiki.service.api.RenderService"
    class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.RenderServiceImpl">
    <property name="log"><ref bean="rwiki-logger"/></property>

    <property name="renderContextFactory"><ref bean="renderContextFactory"/>
    </property>
    <property name="renderEngineFactory"><ref bean="renderEngineFactory"/>
    </property>
    <!-- comment the cache out to disable it -->
    <property name="renderCache"><ref bean="rwikiRenderCache"/></property>
  </bean>

  <!-- The RWiki Object service, component level -->
  <bean id="uk.ac.cam.caret.sakai.rwiki.service.api.RWikiObjectService"
    class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.RWikiObjectServiceImpl"
    init-method="init" destroy-method="destroy" >
    <property name="log"><ref bean="rwiki-logger"/></property>
    <property name="renderService"><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RenderService"/></property>
    <property name="RWikiCurrentObjectDao"><ref bean="rwikiCurrentObjectDao"/></property>
    <property name="RWikiHistoryObjectDao"><ref bean="rwikiHistoryObjectDao"/></property>
    <property name="securityService"><ref bean="securityService"/></property>
    <property name="handlers">
      <map>
        <entry key=""><ref bean="rwikiRAWHandler" /></entry>
        <entry key="html"><ref bean="rwikiHTMLHandler" /></entry>
        <entry key="odf"><ref bean="rwikiODFHandler" /></entry>
        <entry key="rss"><ref bean="rwikiRSSHandler" /></entry>
      </map>
    </property>
  </bean>

  <!-- The base level radeox render engine -->

  <bean id="baseRenderEngine" class="uk.ac.cam.caret.sakai.rwiki.component.radeox.service.impl.RWikiBaseRenderEngine" init-method="init">
    <property name="log"><ref bean="rwiki-logger"/></property>
  </bean>



  <!-- The Rendered content cache, impl uses ehcache which is initialised on first use, if cache fails
  it is re-initialised -->
  <bean id="rwikiRenderCache" class="uk.ac.cam.caret.sakai.rwiki.component.radeox.service.impl.RenderCacheImpl" 
    init-method="init" >
    <property name="log"><ref bean="rwiki-logger"/></property>
    <property name="cacheName"><value>rwiki-render-cache</value></property>
  </bean>
  
  
  <bean id="rwikiRAWHandler" 
    class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.XSLTEntityHandler"  
    init-method="init"  destroy-method="destroy" >
    <!-- from XSLTEntityHandler -->
    <!-- The transformer use on the stream -->
    <property name="xslt"><value>/uk/ac/cam/caret/sakai/rwiki/component/service/impl/null.xslt</value></property>
    <property name="minorType"><value></value></property>    
    <property name="logger"><ref bean="rwiki-logger"/></property>
    <property name="renderService"><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RenderService"/></property>
    <property name="defaultStackTrace"><value>Failed To generate Stack Trace : {0}</value></property>
    <property name="errorFormat"><value>Error encounvered performing transform : {0} \n {1}</value></property>
    <property name="authZPrefix" ><value>/wiki</value></property>
    <property name="anchorLinkFormat" ><value>/access/wiki{0}.#{1}</value></property>
    <property name="standardLinkFormat" ><value>/access/wiki{0}.</value></property>
    <property name="hrefTagFormat" ><value>&lt;a href="{0}" &gt;{1}&lt;/a&gt;</value></property>
    <property name="accessURLStart" ><value>/wiki/</value></property>
    <property name="responseHeaders">
      <map>
        <entry key="content-type"><value>text/xml</value></entry>
      </map>     
    </property>
    <property name="outputProperties">
      <map>
        <entry key="indent"><value>yes</value></entry>
        <entry key="encoding"><value>UTF-8</value></entry>
        <entry key="media-type"><value>text/xml</value></entry>
        <entry key="{http://xml.apache.org/xalan}indent-amount"><value>2</value></entry> 
        <!--
          <entry key="{http://xml.apache.org/xalan}content-handler"><value>org.apache.xml.serializer.ToHTMLStream</value></entry> 
          <entry key="{http://xml.apache.org/xalan}entities"><value>org/apache/xml/serializer/HTMLEntities</value></entry> 
          
        -->
      </map>     
    </property>
  </bean>
  
  <!-- these are EntityProducer handler beans, the config is bean dependant -->
  <bean id="rwikiHTMLHandler" 
    class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.XSLTEntityHandler"  
    init-method="init"  destroy-method="destroy" >
      <!-- from XSLTEntityHandler -->
      <!-- The transformer use on the stream -->
     <property name="xslt"><value>/uk/ac/cam/caret/sakai/rwiki/component/service/impl/tohtml.xslt</value></property>
    <property name="minorType"><value>html</value></property>    
    <property name="logger"><ref bean="rwiki-logger"/></property>
    <property name="renderService"><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RenderService"/></property>
    <property name="defaultStackTrace"><value>Failed To generate Stack Trace : {0}</value></property>
    <property name="errorFormat"><value>Error encounvered performing transform : {0} \n {1}</value></property>
    <property name="authZPrefix" ><value>/wiki</value></property>
    <property name="anchorLinkFormat" ><value>/access/wiki{0}.html#{1}</value></property>
    <property name="standardLinkFormat" ><value>/access/wiki{0}.html</value></property>
    <property name="hrefTagFormat" ><value>&lt;a href="{0}" &gt;{1}&lt;/a&gt;</value></property>
    <property name="accessURLStart" ><value>/wiki/</value></property>
    <property name="feedFormat"><value>&lt;a href="/access{0}html" &gt;&lt;img src="/library/image/sakai/html.gif" border="0" /&gt;&lt;/a&gt;</value></property>
    <property name="responseHeaders">
      <map>
        <entry key="content-type"><value>text/html</value></entry>
      </map>     
    </property>
    <property name="outputProperties">
      <map>
        <entry key="omit-xml-declaration"><value>yes</value></entry>
        <entry key="indent"><value>yes</value></entry>
        <entry key="encoding"><value>UTF-8</value></entry>
        <entry key="version"><value>4.0</value></entry>
        <entry key="media-type"><value>text/html</value></entry>
        <entry key="{http://xml.apache.org/xalan}indent-amount"><value>2</value></entry> 
        <!--
          <entry key="{http://xml.apache.org/xalan}content-handler"><value>org.apache.xml.serializer.ToHTMLStream</value></entry> 
        <entry key="{http://xml.apache.org/xalan}entities"><value>org/apache/xml/serializer/HTMLEntities</value></entry> 

-->
        <entry key="{http://xml.apache.org/xalan}use-url-escaping"><value>yes</value></entry> 
        <entry key="{http://xml.apache.org/xalan}omit-meta-tag"><value>no</value></entry> 
      </map>     
    </property>
  </bean>
  <bean id="rwikiODFHandler"
    class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.XSLTEntityHandler"  
    init-method="init"  destroy-method="destroy" >
    <property name="xslt"><value>/uk/ac/cam/caret/sakai/rwiki/component/service/impl/null.xslt</value></property>
    <property name="minorType"><value>odf</value></property>    
    <property name="logger"><ref bean="rwiki-logger"/></property>
    <property name="renderService"><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RenderService"/></property>
    <property name="defaultStackTrace"><value>Failed To generate Stack Trace : {0}</value></property>
    <property name="errorFormat"><value>Error encounvered performing transform : {0} \n {1}</value></property>
    <property name="authZPrefix" ><value>/wiki</value></property>
    <property name="anchorLinkFormat" ><value>/access/wiki{0}.html#{1}</value></property>
    <property name="standardLinkFormat" ><value>/access/wiki{0}.html</value></property>
    <property name="hrefTagFormat" ><value>&lt;a href="{0}" &gt;{1}&lt;/a&gt;</value></property>
    <property name="accessURLStart" ><value>/wiki/</value></property>
    <property name="feedFormat"><value>&lt;a href="/access{0}odf" &gt;&lt;img src="/library/image/sakai/word.gif" border="0" /&gt;&lt;/a&gt;</value></property>
    
  </bean>
  <bean id="rwikiRSSHandler"
    class="uk.ac.cam.caret.sakai.rwiki.component.service.impl.XLSTChangesHandler"  
    init-method="init"  destroy-method="destroy" >
    <property name="xslt"><value>/uk/ac/cam/caret/sakai/rwiki/component/service/impl/torss10.xslt</value></property>
    <property name="minorType"><value>rss</value></property>    
    <property name="logger"><ref bean="rwiki-logger"/></property>
    <property name="renderService"><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RenderService"/></property>
    <property name="defaultStackTrace"><value>Failed To generate Stack Trace : {0}</value></property>
    <property name="errorFormat"><value>Error encounvered performing transform : {0} \n {1}</value></property>
    <property name="authZPrefix" ><value>/wiki</value></property>
    <property name="anchorLinkFormat" ><value>/access/wiki{0}.html#{1}</value></property>
    <property name="standardLinkFormat" ><value>/access/wiki{0}.html</value></property>
    <property name="hrefTagFormat" ><value>&lt;a href="{0}" &gt;{1}&lt;/a&gt;</value></property>
    <property name="accessURLStart" ><value>/wiki/</value></property>
    <property name="rwikObjectService"><ref bean="uk.ac.cam.caret.sakai.rwiki.service.api.RWikiObjectService" /></property>
    <property name="feedFormat"><value>&lt;a href="/access{0}rss" &gt;&lt;img src="/sakai-rwiki/images/rss10.gif" border="0" /&gt;&lt;/a&gt;</value></property>
    <property name="responseHeaders">
      <map>
        <entry key="content-type"><value>text/xml</value></entry>
      </map>     
    </property>
    <property name="outputProperties">
      <map>
        <entry key="indent"><value>yes</value></entry>
        <entry key="encoding"><value>UTF-8</value></entry>
        <entry key="media-type"><value>text/xml</value></entry>
        <entry key="{http://xml.apache.org/xalan}indent-amount"><value>2</value></entry> 
        <!--
          <entry key="{http://xml.apache.org/xalan}content-handler"><value>org.apache.xml.serializer.ToHTMLStream</value></entry> 
          <entry key="{http://xml.apache.org/xalan}entities"><value>org/apache/xml/serializer/HTMLEntities</value></entry> 
          
        -->
      </map>     
    </property>
    
  </bean>
  
</beans>
